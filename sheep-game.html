<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–ª—É–±–æ—á–∫–∏ ‚Äî –£—é—Ç–Ω–∞—è –∏–≥—Ä–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(180deg, #E8F4F8 0%, #FDF0E6 50%, #F5E6D3 100%);
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            margin: 0 auto;
            position: relative;
            background: linear-gradient(180deg, 
                #B8D4E3 0%,      /* –Ω–µ–±–æ */
                #D4E8F0 30%,     /* —Å–≤–µ—Ç–ª–æ–µ –Ω–µ–±–æ */
                #E8F0D8 60%,     /* —Ö–æ–ª–º—ã */
                #D8E8C8 100%     /* —Ç—Ä–∞–≤–∞ */
            );
            overflow: hidden;
        }

        /* –û–±–ª–∞–∫–∞ –Ω–∞ —Ñ–æ–Ω–µ */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            filter: blur(2px);
        }

        .cloud::before, .cloud::after {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }

        .cloud-1 {
            width: 80px;
            height: 30px;
            top: 5%;
            left: 10%;
            animation: floatCloud 20s ease-in-out infinite;
        }

        .cloud-2 {
            width: 100px;
            height: 35px;
            top: 8%;
            right: 15%;
            animation: floatCloud 25s ease-in-out infinite reverse;
        }

        .cloud-3 {
            width: 60px;
            height: 25px;
            top: 15%;
            left: 50%;
            animation: floatCloud 18s ease-in-out infinite;
        }

        @keyframes floatCloud {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(20px); }
        }

        /* UI –í–µ—Ä—Ö */
        #ui-top {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        #level-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #level-num {
            font-weight: 600;
            color: #7B9E89;
            font-size: 14px;
        }

        /* –¶–µ–ª–∏ —É—Ä–æ–≤–Ω—è */
        #goals {
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.85);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .goal-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
        }

        .goal-icon {
            font-size: 18px;
        }

        .goal-count {
            font-weight: 600;
            color: #7B9E89;
        }

        .goal-item.completed .goal-count {
            color: #9DC08B;
        }

        /* –ö–Ω–æ–ø–∫–∞ –ø–∞—É–∑—ã */
        #pause-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.85);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        #pause-btn:hover {
            transform: scale(1.1);
        }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        #game-field {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
        }

        #game-canvas {
            display: block;
            width: 100%;
            touch-action: none;
        }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –æ–≤–µ—á–∫–æ–π */
        #ui-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 20px;
            pointer-events: none;
        }

        /* –û–≤–µ—á–∫–∞ */
        #sheep-container {
            position: relative;
            width: 100px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #sheep {
            font-size: 60px;
            animation: sheepIdle 2s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
            transition: transform 0.3s;
        }

        @keyframes sheepIdle {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-3px) rotate(2deg); }
        }

        #sheep.happy {
            animation: sheepHappy 0.5s ease;
        }

        @keyframes sheepHappy {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
            100% { transform: translateY(0) scale(1); }
        }

        #sheep.spin {
            animation: sheepSpin 0.8s ease;
        }

        @keyframes sheepSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #sheep.clap {
            animation: sheepClap 0.6s ease;
        }

        @keyframes sheepClap {
            0%, 100% { transform: scale(1); }
            25%, 75% { transform: scale(1.15); }
            50% { transform: scale(0.95); }
        }

        /* –ü—Ä–µ–≤—å—é –∫–ª—É–±–∫–æ–≤ */
        #yarn-preview {
            position: absolute;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .preview-yarn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 -3px 6px rgba(0,0,0,0.1), inset 0 3px 6px rgba(255,255,255,0.4);
            position: relative;
            overflow: hidden;
        }

        .preview-yarn::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 12px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            transform: rotate(-30deg);
        }

        #next-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* –õ–∏–Ω–∏—è –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è */
        #aim-line {
            position: absolute;
            bottom: 130px;
            left: 50%;
            width: 3px;
            height: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.8), transparent);
            transform-origin: bottom center;
            pointer-events: none;
            border-radius: 2px;
            transition: height 0.1s;
        }

        /* –¢–µ–∫—É—â–∏–π –∫–ª—É–±–æ–∫ –¥–ª—è –≤—ã—Å—Ç—Ä–µ–ª–∞ */
        #current-yarn {
            position: absolute;
            bottom: 95px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 -4px 8px rgba(0,0,0,0.1), inset 0 4px 8px rgba(255,255,255,0.4);
            transition: transform 0.3s, background 0.2s;
            overflow: hidden;
        }

        #current-yarn::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: 16px;
            height: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            transform: rotate(-30deg);
        }

        /* –¢–µ–∫—Å—Ç—É—Ä–∞ –Ω–∏—Ç–æ–∫ –Ω–∞ –∫–ª—É–±–∫–µ */
        #current-yarn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 3px,
                rgba(0,0,0,0.03) 3px,
                rgba(0,0,0,0.03) 6px
            );
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: linear-gradient(180deg, #FFF9F5 0%, #FFF 100%);
            padding: 32px;
            border-radius: 24px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal h2 {
            font-size: 24px;
            color: #7B9E89;
            margin-bottom: 16px;
        }

        .modal p {
            color: #666;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-btn {
            padding: 14px 32px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9DC08B 0%, #7B9E89 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(123, 158, 137, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(123, 158, 137, 0.5);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ */
        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            font-size: 16px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #e0e0e0;
            color: #666;
        }

        /* –ú–æ–¥–∞–ª–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è */
        .level-intro {
            max-width: 360px;
            position: relative;
        }

        .level-intro-header {
            margin-bottom: 8px;
        }
        
        .level-intro-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .level-intro-num {
            background: linear-gradient(135deg, #9DC08B 0%, #7B9E89 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .level-intro-goals {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .intro-goal {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: #f8f8f8;
            padding: 12px 20px;
            border-radius: 12px;
        }

        .intro-goal-icon {
            font-size: 28px;
        }

        .intro-goal-text {
            font-size: 13px;
            color: #666;
        }

        .level-intro-tip {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #8B7355;
            line-height: 1.5;
        }

        .level-intro-tip:empty {
            display: none;
        }

        .level-intro-new {
            margin-bottom: 20px;
        }

        .level-intro-new:empty {
            display: none;
        }

        .new-mechanic {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .new-mechanic:last-child {
            margin-bottom: 0;
        }

        .new-mechanic-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .new-mechanic-text {
            text-align: left;
        }

        .new-mechanic-title {
            font-weight: 600;
            color: #5D8A66;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .new-mechanic-desc {
            font-size: 12px;
            color: #6B8E6B;
            line-height: 1.4;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) scale(0);
            }
        }

        /* –ü—ã–ª—å—Ü–∞ / –≤–æ–ª–æ–∫–Ω–∞ */
        .fiber {
            position: absolute;
            width: 3px;
            height: 8px;
            border-radius: 2px;
            pointer-events: none;
            animation: fiberFloat 1.2s ease-out forwards;
        }

        @keyframes fiberFloat {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(var(--tx), var(--ty)) rotate(var(--rot));
            }
        }

        /* –•–æ–ª–º–∏–∫–∏ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ */
        .hill {
            position: absolute;
            bottom: 0;
            border-radius: 50% 50% 0 0;
        }

        .hill-1 {
            width: 200px;
            height: 80px;
            left: -50px;
            background: linear-gradient(180deg, #C8E6C9 0%, #A5D6A7 100%);
        }

        .hill-2 {
            width: 250px;
            height: 100px;
            right: -80px;
            background: linear-gradient(180deg, #C5E1A5 0%, #AED581 100%);
        }

        /* –¶–≤–µ—Ç–æ—á–∫–∏ */
        .flower {
            position: absolute;
            font-size: 16px;
            animation: flowerSway 3s ease-in-out infinite;
        }

        @keyframes flowerSway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        /* –≠–∫—Ä–∞–Ω —É—Ä–æ–≤–Ω–µ–π */
        #level-select {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #E8F4F8 0%, #FDF0E6 50%, #F5E6D3 100%);
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            overflow-y: auto;
        }

        #level-select.hidden {
            display: none;
        }

        #level-select h1 {
            font-size: 32px;
            color: #7B9E89;
            margin-bottom: 8px;
        }

        #level-select .subtitle {
            color: #999;
            margin-bottom: 32px;
            font-size: 14px;
        }

        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            max-width: 320px;
        }

        .level-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .level-btn.unlocked {
            background: linear-gradient(135deg, #fff 0%, #f5f5f5 100%);
            color: #7B9E89;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .level-btn.unlocked:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .level-btn.completed {
            background: linear-gradient(135deg, #9DC08B 0%, #7B9E89 100%);
            color: white;
        }

        .level-btn.locked {
            background: #ddd;
            color: #aaa;
            cursor: not-allowed;
        }

        .level-btn .stars {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            white-space: nowrap;
        }

        /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #E8F4F8 0%, #FDF0E6 50%, #F5E6D3 100%);
            z-index: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        #start-screen.hidden {
            display: none;
        }

        #start-screen .logo {
            font-size: 80px;
            margin-bottom: 16px;
            animation: sheepIdle 2s ease-in-out infinite;
        }

        #start-screen h1 {
            font-size: 36px;
            color: #7B9E89;
            margin-bottom: 8px;
        }

        #start-screen .tagline {
            color: #999;
            margin-bottom: 48px;
            font-size: 16px;
        }

        #start-btn {
            padding: 18px 64px;
            font-size: 20px;
        }

        /* –ó–≤—ë–∑–¥–æ—á–∫–∏ –ø–æ–±–µ–¥—ã */
        .win-stars {
            font-size: 40px;
            margin-bottom: 16px;
            letter-spacing: 8px;
        }
    </style>
</head>
<body>

<!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
<div id="start-screen">
    <div class="logo">üêë</div>
    <h1>–ö–ª—É–±–æ—á–∫–∏</h1>
    <p class="tagline">—É—é—Ç–Ω–∞—è –∏–≥—Ä–∞ –¥–ª—è –æ—Ç–¥—ã—Ö–∞</p>
    <button class="modal-btn btn-primary" id="start-btn">–ò–≥—Ä–∞—Ç—å</button>
</div>

<!-- –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è -->
<div id="level-select" class="hidden">
    <h1>–£—Ä–æ–≤–Ω–∏</h1>
    <p class="subtitle">–≤—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å</p>
    <div class="levels-grid" id="levels-grid">
        <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
    </div>
</div>

<!-- –ò–≥—Ä–æ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div id="game-container" style="display: none;">
    <!-- –û–±–ª–∞–∫–∞ -->
    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="cloud cloud-3"></div>

    <!-- –•–æ–ª–º–∏–∫–∏ -->
    <div class="hill hill-1"></div>
    <div class="hill hill-2"></div>

    <!-- –¶–≤–µ—Ç–æ—á–∫–∏ -->
    <div class="flower" style="bottom: 60px; left: 20px;">üå∏</div>
    <div class="flower" style="bottom: 45px; left: 60px; animation-delay: -1s;">üåº</div>
    <div class="flower" style="bottom: 55px; right: 30px; animation-delay: -0.5s;">üå∑</div>
    <div class="flower" style="bottom: 40px; right: 80px; animation-delay: -1.5s;">üåª</div>

    <!-- UI –≤–µ—Ä—Ö -->
    <div id="ui-top">
        <div id="level-info">
            <span id="level-num">–£—Ä–æ–≤–µ–Ω—å 1</span>
        </div>
        <div id="goals">
            <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
        </div>
        <button id="pause-btn">‚è∏Ô∏è</button>
    </div>

    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
    <div id="game-field">
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- –õ–∏–Ω–∏—è –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è -->
    <div id="aim-line"></div>

    <!-- –¢–µ–∫—É—â–∏–π –∫–ª—É–±–æ–∫ -->
    <div id="current-yarn"></div>

    <!-- UI –Ω–∏–∑ -->
    <div id="ui-bottom">
        <div id="sheep-container">
            <div id="sheep">üêë</div>
        </div>
    </div>

    <!-- –ü—Ä–µ–≤—å—é —Å–ª–µ–¥—É—é—â–µ–≥–æ -->
    <div id="yarn-preview">
        <span id="next-label">—Å–ª–µ–¥.</span>
        <div class="preview-yarn" id="next-yarn"></div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–∞—É–∑—ã -->
<div class="modal" id="pause-modal">
    <div class="modal-content">
        <h2>–ü–∞—É–∑–∞</h2>
        <p>–û—Ç–¥–æ—Ö–Ω–∏ –Ω–µ–º–Ω–æ–≥–æ üåø</p>
        <button class="modal-btn btn-primary" id="resume-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <button class="modal-btn btn-secondary" id="menu-btn">–í –º–µ–Ω—é</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–±–µ–¥—ã -->
<div class="modal" id="win-modal">
    <div class="modal-content">
        <div class="win-stars" id="win-stars">‚≠ê‚≠ê‚≠ê</div>
        <h2>–û—Ç–ª–∏—á–Ω–æ!</h2>
        <p id="win-text">–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!</p>
        <button class="modal-btn btn-primary" id="next-level-btn">–î–∞–ª—å—à–µ</button>
        <button class="modal-btn btn-secondary" id="win-menu-btn">–ú–µ–Ω—é</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–∞ -->
<div class="modal" id="lose-modal">
    <div class="modal-content">
        <h2>–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å</h2>
        <p>–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ üå∏</p>
        <button class="modal-btn btn-primary" id="retry-btn">–ó–∞–Ω–æ–≤–æ</button>
        <button class="modal-btn btn-secondary" id="lose-menu-btn">–ú–µ–Ω—é</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è -->
<div class="modal" id="level-intro-modal">
    <div class="modal-content level-intro">
        <button class="modal-close" id="intro-close-btn">‚úï</button>
        <div class="level-intro-header">
            <span class="level-intro-num" id="intro-level-num">–£—Ä–æ–≤–µ–Ω—å 1</span>
        </div>
        <h2 id="intro-title">–ù–∞—á–∏–Ω–∞–µ–º!</h2>
        <div class="level-intro-goals" id="intro-goals">
            <!-- —Ü–µ–ª–∏ —É—Ä–æ–≤–Ω—è -->
        </div>
        <div class="level-intro-tip" id="intro-tip">
            <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∞ -->
        </div>
        <div class="level-intro-new" id="intro-new">
            <!-- –Ω–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ -->
        </div>
        <div class="level-intro-buttons">
            <button class="modal-btn btn-secondary" id="intro-back-btn">–ù–∞–∑–∞–¥</button>
            <button class="modal-btn btn-primary" id="start-level-btn">–ò–≥—Ä–∞—Ç—å!</button>
        </div>
    </div>
</div>

<script>
// ============================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´
// ============================================

const COLORS = {
    mint: { fill: '#98D8C8', stroke: '#7BC4B4', emoji: 'üß∂' },
    lavender: { fill: '#C9B1FF', stroke: '#B199E8', emoji: 'üß∂' },
    peach: { fill: '#FFCBA4', stroke: '#E8B48E', emoji: 'üß∂' },
    strawberry: { fill: '#FFB5B5', stroke: '#E89E9E', emoji: 'üß∂' },
    sky: { fill: '#A8D8EA', stroke: '#8FC4D6', emoji: 'üß∂' },
    cream: { fill: '#FFF5E1', stroke: '#E8DEC8', emoji: 'üß∂' }
};

const COLOR_KEYS = Object.keys(COLORS);

const SPECIAL_TYPES = {
    normal: { emoji: 'üß∂' },
    bomb: { emoji: 'üí´' },       // –±–æ–º–±–∞ —Å –±–∞–Ω—Ç–æ–º
    rainbow: { emoji: 'üåà' },    // —Ä–∞–¥—É–∂–Ω—ã–π
    ice: { emoji: '‚ùÑÔ∏è' },        // –ª—ë–¥
    sticky: { emoji: 'üå∏' },     // –ª–∏–ø—É—á–∫–∞/—Ü–≤–µ—Ç–æ–∫
    fog: { emoji: '‚òÅÔ∏è' },        // —Ç—É–º–∞–Ω
    animal: { emoji: 'üê∞' }      // –∑–≤–µ—Ä—É—à–∫–∞ –≤–Ω—É—Ç—Ä–∏
};

// –û–ø–∏—Å–∞–Ω–∏—è —Ü–µ–ª–µ–π –¥–ª—è –º–æ–¥–∞–ª–∫–∏
const GOAL_DESCRIPTIONS = {
    drop: '–û–±—Ä–æ–Ω–∏ –∫–ª—É–±–∫–∏',
    animal: '–û—Å–≤–æ–±–æ–¥–∏ –∑–≤–µ—Ä—É—à–µ–∫',
    ice: '–†–∞—Å—Ç–æ–ø–∏ –ª–µ–¥—è–Ω—ã–µ –∫–ª—É–±–∫–∏',
    bomb: '–í–∑–æ—Ä–≤–∏ –±–æ–º–±—ã',
    sticky: '–£–±–µ—Ä–∏ —Ü–≤–µ—Ç–æ—á–∫–∏',
    match: '–°–æ–±–µ—Ä–∏ –∫–ª—É–±–∫–∏',
    rainbow: '–ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–¥—É–∂–Ω—ã–µ'
};

// –û–ø–∏—Å–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∫
const MECHANIC_DESCRIPTIONS = {
    animal: {
        icon: 'üê∞',
        title: '–ó–≤–µ—Ä—É—à–∫–∏!',
        desc: '–í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª—É–±–∫–∞—Ö –ø—Ä—è—á—É—Ç—Å—è –∑–≤–µ—Ä—É—à–∫–∏. –°–æ–±–µ—Ä–∏ 3+ –∫–ª—É–±–∫–∞ —Ä—è–¥–æ–º —Å –Ω–∏–º–∏, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å!'
    },
    ice: {
        icon: '‚ùÑÔ∏è',
        title: '–õ–µ–¥—è–Ω—ã–µ –∫–ª—É–±–∫–∏',
        desc: '–ü–æ–∫—Ä—ã—Ç—ã –ª—å–¥–æ–º ‚Äî –ø–æ–ø–∞–¥–∏ –¥–≤–∞–∂–¥—ã –ò–õ–ò –æ–±—Ä–æ–Ω–∏ –∏—Ö –≤–Ω–∏–∑!'
    },
    bomb: {
        icon: 'üí´',
        title: '–ë–æ–º–±—ã',
        desc: '–ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ –≤–∑—Ä—ã–≤–∞—é—Ç –≤—Å–µ –∫–ª—É–±–∫–∏ –≤–æ–∫—Ä—É–≥ —Å–µ–±—è!'
    },
    sticky: {
        icon: 'üå∏',
        title: '–¶–≤–µ—Ç–æ—á–∫–∏-–ª–∏–ø—É—á–∫–∏',
        desc: '–£–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∫–ª—É–±–∫–∏ –æ—Ç –ø–∞–¥–µ–Ω–∏—è. –£–±–µ—Ä–∏ –∏—Ö, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –æ–±–≤–∞–ª!'
    },
    rainbow: {
        icon: 'üåà',
        title: '–†–∞–¥—É–∂–Ω—ã–µ –∫–ª—É–±–∫–∏',
        desc: '–°–æ–≤–ø–∞–¥–∞—é—Ç —Å –ª—é–±—ã–º —Ü–≤–µ—Ç–æ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Å —É–º–æ–º!'
    },
    fog: {
        icon: '‚òÅÔ∏è',
        title: '–¢—É–º–∞–Ω–Ω—ã–µ –∫–ª—É–±–∫–∏',
        desc: '–°–∫—Ä—ã–≤–∞—é—Ç —Å–≤–æ–π —Ü–≤–µ—Ç. –ü–æ–ø–∞–¥–∏ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã —Ä–∞—Å—Å–µ—è—Ç—å —Ç—É–º–∞–Ω'
    }
};

// –£—Ä–æ–≤–Ω–∏
const LEVELS = [
    // –£—Ä–æ–≤–µ–Ω—å 1 ‚Äî –±–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞, –æ–±–≤–∞–ª—ã
    {
        colors: ['mint', 'lavender', 'peach'],
        rows: 5,
        goals: [{ type: 'drop', count: 10, icon: '‚¨áÔ∏è' }],
        moves: 20,
        intro: {
            title: '–ù–∞—á–∏–Ω–∞–µ–º!',
            tip: '–°–æ–µ–¥–∏–Ω—è–π 3+ –∫–ª—É–±–∫–∞ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞. –ö–æ–≥–¥–∞ –≥—Ä—É–ø–ø–∞ —Ç–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å –≤–µ—Ä—Ö–æ–º ‚Äî –æ–Ω–∞ –ø–∞–¥–∞–µ—Ç!'
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 2 ‚Äî –∑–≤–µ—Ä—É—à–∫–∏
    {
        colors: ['mint', 'lavender', 'peach', 'strawberry'],
        rows: 6,
        specials: [{ type: 'animal', count: 3 }],
        goals: [{ type: 'animal', count: 3, icon: 'üê∞' }],
        moves: 25,
        intro: {
            title: '–°–ø–∞—Å–∞–µ–º –∑–≤–µ—Ä—É—à–µ–∫!',
            tip: '–í–∏–¥–∏—à—å –≥–ª–∞–∑–∫–∏ –≤ –∫–ª—É–±–∫–∞—Ö? –≠—Ç–æ –∑–≤–µ—Ä—É—à–∫–∏! –°–æ–±–µ—Ä–∏ –∫–ª—É–±–∫–∏ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –∏—Ö –æ—Å–≤–æ–±–æ–¥–∏—Ç—å.',
            newMechanics: ['animal']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 3 ‚Äî –ª—ë–¥
    {
        colors: ['mint', 'lavender', 'sky'],
        rows: 6,
        specials: [{ type: 'ice', count: 5 }],
        goals: [{ type: 'ice', count: 5, icon: '‚ùÑÔ∏è' }],
        moves: 25,
        intro: {
            title: '–õ–µ–¥—è–Ω–æ–π —É—Ä–æ–≤–µ–Ω—å',
            tip: '–õ–µ–¥—è–Ω—ã–µ –∫–ª—É–±–∫–∏: –ø–æ–ø–∞–¥–∏ –¥–≤–∞–∂–¥—ã –ò–õ–ò –æ–±—Ä–æ–Ω–∏ –∏—Ö –≤–Ω–∏–∑ ‚Äî –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –ª—ë–¥ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É!',
            newMechanics: ['ice']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 4 ‚Äî –æ–±–≤–∞–ª—ã (–º–Ω–æ–≥–æ)
    {
        colors: ['mint', 'peach', 'cream', 'strawberry'],
        rows: 7,
        goals: [{ type: 'drop', count: 25, icon: '‚¨áÔ∏è' }],
        moves: 20,
        intro: {
            title: '–ë–æ–ª—å—à–æ–π –æ–±–≤–∞–ª!',
            tip: '–¶–µ–ª—å ‚Äî –æ–±—Ä—É—à–∏—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –∫–ª—É–±–∫–æ–≤. –ò—â–∏ –º–µ—Å—Ç–∞, –≥–¥–µ –æ–¥–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤—ã–∑–æ–≤–µ—Ç —Ü–µ–ø–Ω—É—é —Ä–µ–∞–∫—Ü–∏—é!'
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 5 ‚Äî –±–æ–º–±—ã
    {
        colors: ['mint', 'lavender', 'peach'],
        rows: 6,
        specials: [{ type: 'bomb', count: 3 }],
        goals: [{ type: 'bomb', count: 3, icon: 'üí´' }],
        moves: 25,
        intro: {
            title: '–ë—É–º!',
            tip: '–ë–æ–º–±—ã –≤–∑—Ä—ã–≤–∞—é—Ç –≤—Å—ë –≤–æ–∫—Ä—É–≥ –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏. –û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ!',
            newMechanics: ['bomb']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 6 ‚Äî –ª–∏–ø—É—á–∫–∏
    {
        colors: ['lavender', 'peach', 'sky'],
        rows: 7,
        specials: [{ type: 'sticky', count: 4 }],
        goals: [{ type: 'sticky', count: 4, icon: 'üå∏' }],
        moves: 30,
        intro: {
            title: '–¶–≤–µ—Ç–æ—á–∫–∏-–ª–∏–ø—É—á–∫–∏',
            tip: '–¶–≤–µ—Ç–æ—á–∫–∏ —É–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≥—Ä—É–ø–ø—ã –æ—Ç –ø–∞–¥–µ–Ω–∏—è. –£–±–µ—Ä–∏ –∏—Ö, —á—Ç–æ–±—ã –≤—ã–∑–≤–∞—Ç—å –æ–±–≤–∞–ª!',
            newMechanics: ['sticky']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 7 ‚Äî —Ä–∞–¥—É–∂–Ω—ã–µ
    {
        colors: ['mint', 'lavender', 'peach', 'strawberry'],
        rows: 6,
        goals: [{ type: 'drop', count: 30, icon: '‚¨áÔ∏è' }],
        rainbowChance: 0.1,
        moves: 25,
        intro: {
            title: '–†–∞–¥—É–≥–∞!',
            tip: '–ò–Ω–æ–≥–¥–∞ –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Ä–∞–¥—É–∂–Ω—ã–µ –∫–ª—É–±–∫–∏ ‚Äî –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ª—é–±—ã–º —Ü–≤–µ—Ç–æ–º!',
            newMechanics: ['rainbow']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 8 ‚Äî —Ç—É–º–∞–Ω
    {
        colors: ['mint', 'sky', 'cream'],
        rows: 7,
        specials: [{ type: 'fog', count: 6 }],
        goals: [{ type: 'match', count: 40, icon: '‚ú®' }],
        moves: 30,
        intro: {
            title: '–í —Ç—É–º–∞–Ω–µ',
            tip: '–¢—É–º–∞–Ω–Ω—ã–µ –∫–ª—É–±–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç —Å–≤–æ–π –Ω–∞—Å—Ç–æ—è—â–∏–π —Ü–≤–µ—Ç. –ü–æ–ø–∞–¥–∏ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –∏—Ö —Ä–∞—Å–∫—Ä—ã—Ç—å!',
            newMechanics: ['fog']
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 9 ‚Äî –∫–æ–º–±–æ
    {
        colors: ['mint', 'lavender', 'peach', 'strawberry', 'sky'],
        rows: 8,
        specials: [{ type: 'ice', count: 3 }, { type: 'sticky', count: 2 }],
        goals: [
            { type: 'drop', count: 20, icon: '‚¨áÔ∏è' },
            { type: 'ice', count: 3, icon: '‚ùÑÔ∏è' }
        ],
        moves: 35,
        intro: {
            title: '–ö–æ–º–±–æ-—É—Ä–æ–≤–µ–Ω—å!',
            tip: '–ó–¥–µ—Å—å –∏ –ª—ë–¥, –∏ —Ü–≤–µ—Ç–æ—á–∫–∏. –°–Ω–∞—á–∞–ª–∞ —É–±–µ—Ä–∏ –ª–∏–ø—É—á–∫–∏, –ø–æ—Ç–æ–º —Ä–∞–∑–±–µ–π –ª—ë–¥ –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –æ–±–≤–∞–ª–∞!'
        }
    },
    // –£—Ä–æ–≤–µ–Ω—å 10 ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π, –ª–µ–≥—á–µ
    {
        colors: ['mint', 'lavender', 'peach'],
        rows: 5,
        specials: [{ type: 'animal', count: 2 }],
        goals: [{ type: 'animal', count: 2, icon: 'üê∞' }],
        moves: 30,
        rainbowChance: 0.15,
        intro: {
            title: '–§–∏–Ω–∞–ª! üéâ',
            tip: '–ü–æ—Å–ª–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å! –û—Å–≤–æ–±–æ–¥–∏ –∑–≤–µ—Ä—É—à–µ–∫ –∏ —Ä–∞–¥—É–π—Å—è –ø–æ–±–µ–¥–µ!'
        }
    }
];

// ============================================
// –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´
// ============================================

let canvas, ctx;
let gameState = {
    screen: 'start', // start, levels, playing
    currentLevel: 0,
    unlockedLevels: 1,
    levelStars: {},
    
    // –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
    grid: [],
    cols: 9,
    rows: 0,
    cellSize: 42,
    offsetX: 0,
    offsetY: 20,
    
    // –í—ã—Å—Ç—Ä–µ–ª
    currentYarn: null,
    nextYarn: null,
    isAiming: false,
    aimAngle: Math.PI / 2,
    
    // –ü—Ä–æ–≥—Ä–µ—Å—Å
    moves: 0,
    maxMoves: 20,
    goals: [],
    progress: {},
    
    // –ê–Ω–∏–º–∞—Ü–∏–∏
    fallingYarns: [],
    particles: [],
    isAnimating: false,
    
    // –ü–∞—É–∑–∞
    isPaused: false
};

// ============================================
// –ó–í–£–ö–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê
// ============================================

let audioCtx = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

// –ú—è–≥–∫–∏–π –∑–≤—É–∫ –≤—ã—Å—Ç—Ä–µ–ª–∞ ‚Äî "—Ç—É–ø"
function playShootSound() {
    if (!audioCtx) return;
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.frequency.setValueAtTime(180, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.1);
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
    
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.15);
}

// –ú—è–≥–∫–∏–π –∑–≤—É–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è ‚Äî "–ø—É—Ñ—Ñ"
function playMatchSound() {
    if (!audioCtx) return;
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    
    osc.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = 'sine';
    osc.frequency.setValueAtTime(400, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime + 0.2);
    
    filter.type = 'lowpass';
    filter.frequency.setValueAtTime(800, audioCtx.currentTime);
    
    gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);
    
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.25);
}

// –ó–≤—É–∫ –æ–±–≤–∞–ª–∞ ‚Äî —Å–µ—Ä–∏—è –º—è–≥–∫–∏—Ö "–ø—É–º"
function playDropSound(count) {
    if (!audioCtx) return;
    
    const drops = Math.min(count, 5); // –º–∞–∫—Å–∏–º—É–º 5 –∑–≤—É–∫–æ–≤
    
    for (let i = 0; i < drops; i++) {
        setTimeout(() => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(150 + i * 30, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(60, audioCtx.currentTime + 0.15);
            
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
            
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.2);
        }, i * 80);
    }
}

// –†–∞–¥–æ—Å—Ç–Ω—ã–π –∑–≤—É–∫ –ø–æ–±–µ–¥—ã
function playWinSound() {
    if (!audioCtx) return;
    
    const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
    
    notes.forEach((freq, i) => {
        setTimeout(() => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.3);
        }, i * 150);
    });
}

// –ó–≤—É–∫ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –∑–≤–µ—Ä—É—à–∫–∏ ‚Äî –º–∏–ª—ã–π "–ø–∏–Ω–≥"
function playAnimalSound() {
    if (!audioCtx) return;
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    osc.frequency.setValueAtTime(1000, audioCtx.currentTime + 0.1);
    osc.frequency.setValueAtTime(1200, audioCtx.currentTime + 0.2);
    
    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + 0.4);
}

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================

function init() {
    canvas = document.getElementById('game-canvas');
    ctx = canvas.getContext('2d');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    loadProgress();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º canvas
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    // –°–æ–±—ã—Ç–∏—è
    setupEvents();
    
    // –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    showScreen('start');
    
    // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
    requestAnimationFrame(gameLoop);
}

function resizeCanvas() {
    const container = document.getElementById('game-field');
    const width = Math.min(420, window.innerWidth - 30);
    const height = Math.min(500, window.innerHeight - 250);
    
    canvas.width = width;
    canvas.height = height;
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —è—á–µ–π–∫–∏
    gameState.cellSize = Math.floor(width / (gameState.cols + 0.5));
    gameState.offsetX = (width - gameState.cols * gameState.cellSize) / 2;
}

function loadProgress() {
    const saved = localStorage.getItem('sheepGame');
    if (saved) {
        const data = JSON.parse(saved);
        gameState.unlockedLevels = data.unlockedLevels || 1;
        gameState.levelStars = data.levelStars || {};
    }
}

function saveProgress() {
    localStorage.setItem('sheepGame', JSON.stringify({
        unlockedLevels: gameState.unlockedLevels,
        levelStars: gameState.levelStars
    }));
}

// ============================================
// –≠–ö–†–ê–ù–´
// ============================================

function showScreen(screen) {
    gameState.screen = screen;
    
    document.getElementById('start-screen').classList.toggle('hidden', screen !== 'start');
    document.getElementById('level-select').classList.toggle('hidden', screen !== 'levels');
    document.getElementById('game-container').style.display = screen === 'playing' ? 'block' : 'none';
    
    if (screen === 'levels') {
        renderLevelSelect();
    }
}

function renderLevelSelect() {
    const grid = document.getElementById('levels-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < LEVELS.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'level-btn';
        btn.textContent = i + 1;
        
        if (i < gameState.unlockedLevels) {
            btn.classList.add(gameState.levelStars[i] ? 'completed' : 'unlocked');
            btn.onclick = () => showLevelIntro(i);
            
            if (gameState.levelStars[i]) {
                const stars = document.createElement('span');
                stars.className = 'stars';
                stars.textContent = '‚≠ê'.repeat(gameState.levelStars[i]);
                btn.appendChild(stars);
            }
        } else {
            btn.classList.add('locked');
            btn.textContent = 'üîí';
        }
        
        grid.appendChild(btn);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
function showLevelIntro(levelIndex) {
    const level = LEVELS[levelIndex];
    const intro = level.intro || {};
    
    // –ù–æ–º–µ—Ä —É—Ä–æ–≤–Ω—è
    document.getElementById('intro-level-num').textContent = `–£—Ä–æ–≤–µ–Ω—å ${levelIndex + 1}`;
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫
    document.getElementById('intro-title').textContent = intro.title || '–í–ø–µ—Ä—ë–¥!';
    
    // –¶–µ–ª–∏ —É—Ä–æ–≤–Ω—è
    const goalsEl = document.getElementById('intro-goals');
    goalsEl.innerHTML = '';
    level.goals.forEach(goal => {
        const div = document.createElement('div');
        div.className = 'intro-goal';
        div.innerHTML = `
            <span class="intro-goal-icon">${goal.icon}</span>
            <span class="intro-goal-text">${GOAL_DESCRIPTIONS[goal.type] || goal.type}: ${goal.count}</span>
        `;
        goalsEl.appendChild(div);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ–¥—ã
    const movesDiv = document.createElement('div');
    movesDiv.className = 'intro-goal';
    movesDiv.innerHTML = `
        <span class="intro-goal-icon">üéØ</span>
        <span class="intro-goal-text">–•–æ–¥–æ–≤: ${level.moves}</span>
    `;
    goalsEl.appendChild(movesDiv);
    
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
    document.getElementById('intro-tip').textContent = intro.tip || '';
    
    // –ù–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏
    const newEl = document.getElementById('intro-new');
    newEl.innerHTML = '';
    if (intro.newMechanics && intro.newMechanics.length > 0) {
        intro.newMechanics.forEach(mechanic => {
            const info = MECHANIC_DESCRIPTIONS[mechanic];
            if (info) {
                const div = document.createElement('div');
                div.className = 'new-mechanic';
                div.innerHTML = `
                    <span class="new-mechanic-icon">${info.icon}</span>
                    <div class="new-mechanic-text">
                        <div class="new-mechanic-title">–ù–æ–≤–æ–µ: ${info.title}</div>
                        <div class="new-mechanic-desc">${info.desc}</div>
                    </div>
                `;
                newEl.appendChild(div);
            }
        });
    }
    
    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–ø—É—Å–∫–∞—Ç—å
    gameState.pendingLevel = levelIndex;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    document.getElementById('level-intro-modal').classList.add('active');
}

// ============================================
// –£–†–û–í–ï–ù–¨
// ============================================

function startLevel(levelIndex) {
    gameState.currentLevel = levelIndex;
    const level = LEVELS[levelIndex];
    
    // –í–ê–ñ–ù–û: —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–∞—É–∑—ã
    gameState.isAnimating = false;
    gameState.isPaused = false;
    gameState.isAiming = false;
    gameState.aimAngle = Math.PI / 2;
    gameState.levelEnded = false;  // —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    gameState.rows = level.rows;
    gameState.maxMoves = level.moves;
    gameState.moves = 0;
    gameState.goals = JSON.parse(JSON.stringify(level.goals));
    gameState.progress = {};
    gameState.goals.forEach(g => gameState.progress[g.type] = 0);
    
    // –°–æ–∑–¥–∞—ë–º –ø–æ–ª–µ
    createGrid(level);
    
    // –ü–µ—Ä–≤—ã–µ –∫–ª—É–±–∫–∏ –¥–ª—è –≤—ã—Å—Ç—Ä–µ–ª–∞
    gameState.currentYarn = createShootYarn(level);
    gameState.nextYarn = createShootYarn(level);
    
    // –°–±—Ä–æ—Å UI
    updateAimLine(0);
    updateUI();
    showScreen('playing');
}

function createGrid(level) {
    gameState.grid = [];
    
    for (let row = 0; row < level.rows; row++) {
        const rowArr = [];
        const offset = row % 2 === 1 ? 0.5 : 0;
        const colCount = row % 2 === 1 ? gameState.cols - 1 : gameState.cols;
        
        for (let col = 0; col < colCount; col++) {
            const color = level.colors[Math.floor(Math.random() * level.colors.length)];
            rowArr.push({
                color: color,
                type: 'normal',
                x: (col + offset) * gameState.cellSize + gameState.offsetX + gameState.cellSize / 2,
                y: row * gameState.cellSize * 0.866 + gameState.offsetY + gameState.cellSize / 2,
                row: row,
                col: col,
                iceHits: 0,
                visible: true,
                fogHidden: false
            });
        }
        gameState.grid.push(rowArr);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
    if (level.specials) {
        level.specials.forEach(spec => {
            for (let i = 0; i < spec.count; i++) {
                placeSpecial(spec.type);
            }
        });
    }
}

function placeSpecial(type) {
    const attempts = 50;
    for (let i = 0; i < attempts; i++) {
        const row = Math.floor(Math.random() * gameState.grid.length);
        const col = Math.floor(Math.random() * gameState.grid[row].length);
        const yarn = gameState.grid[row][col];
        
        if (yarn && yarn.type === 'normal') {
            yarn.type = type;
            if (type === 'ice') yarn.iceHits = 0;
            return;
        }
    }
}

function createShootYarn(level) {
    let type = 'normal';
    let color = level.colors[Math.floor(Math.random() * level.colors.length)];
    
    if (level.rainbowChance && Math.random() < level.rainbowChance) {
        type = 'rainbow';
        color = null;
    }
    
    return { color, type };
}

// ============================================
// –§–ò–ó–ò–ö–ê / –í–´–°–¢–†–ï–õ
// ============================================

function shoot(angle) {
    if (gameState.isAnimating || gameState.isPaused) return;
    
    const yarn = gameState.currentYarn;
    const startX = canvas.width / 2;
    const startY = canvas.height + 30;
    
    // –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª—ë—Ç–∞
    let x = startX;
    let y = startY;
    const speed = 15;
    const dx = Math.cos(angle) * speed;
    const dy = -Math.sin(angle) * speed;
    
    // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è
    let collision = null;
    for (let step = 0; step < 200 && !collision; step++) {
        x += dx;
        y += dy;
        
        // –û—Ç—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç —Å—Ç–µ–Ω
        if (x < gameState.cellSize / 2) {
            x = gameState.cellSize / 2;
        }
        if (x > canvas.width - gameState.cellSize / 2) {
            x = canvas.width - gameState.cellSize / 2;
        }
        
        // –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞
        if (y < gameState.cellSize / 2) {
            collision = { x, y, hitTop: true };
            break;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∫–ª—É–±–∫–∞–º–∏
        for (let row = 0; row < gameState.grid.length; row++) {
            for (let col = 0; col < gameState.grid[row].length; col++) {
                const target = gameState.grid[row][col];
                if (!target || !target.visible) continue;
                
                const dist = Math.hypot(x - target.x, y - target.y);
                if (dist < gameState.cellSize * 0.9) {
                    collision = { x, y, target, row, col };
                    break;
                }
            }
            if (collision) break;
        }
    }
    
    if (collision) {
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–ª—ë—Ç–∞
        animateShot(startX, startY, collision.x, collision.y, yarn, () => {
            // –†–∞–∑–º–µ—â–∞–µ–º –∫–ª—É–±–æ–∫
            placeYarn(collision, yarn);
        });
    }
    
    // –°–ª–µ–¥—É—é—â–∏–π –∫–ª—É–±–æ–∫
    gameState.currentYarn = gameState.nextYarn;
    gameState.nextYarn = createShootYarn(LEVELS[gameState.currentLevel]);
    gameState.moves++;
    
    updateUI();
}

function animateShot(startX, startY, endX, endY, yarn, callback) {
    gameState.isAnimating = true;
    
    const duration = 200;
    const startTime = Date.now();
    
    function animate() {
        const elapsed = Date.now() - startTime;
        const t = Math.min(elapsed / duration, 1);
        
        const x = startX + (endX - startX) * t;
        const y = startY + (endY - startY) * t;
        
        // –†–∏—Å—É–µ–º –ª–µ—Ç—è—â–∏–π –∫–ª—É–±–æ–∫
        yarn.animX = x;
        yarn.animY = y;
        
        if (t < 1) {
            requestAnimationFrame(animate);
        } else {
            delete yarn.animX;
            delete yarn.animY;
            gameState.isAnimating = false;
            callback();
        }
    }
    
    animate();
}

function placeYarn(collision, yarn) {
    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é —Å–≤–æ–±–æ–¥–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    const pos = findNearestEmpty(collision.x, collision.y);
    
    if (!pos) {
        // –ò–≥—Ä–∞ –ø—Ä–æ–∏–≥—Ä–∞–Ω–∞ ‚Äî –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
        checkLose();
        return;
    }
    
    // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–ª—É–±–æ–∫
    const newYarn = {
        color: yarn.color,
        type: yarn.type,
        x: pos.x,
        y: pos.y,
        row: pos.row,
        col: pos.col,
        visible: true,
        iceHits: 0
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Ç–∫—É
    if (!gameState.grid[pos.row]) {
        gameState.grid[pos.row] = [];
    }
    gameState.grid[pos.row][pos.col] = newYarn;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    setTimeout(() => checkMatches(newYarn), 50);
}

function findNearestEmpty(x, y) {
    let best = null;
    let bestDist = Infinity;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    for (let row = 0; row < 15; row++) {
        const offset = row % 2 === 1 ? 0.5 : 0;
        const colCount = row % 2 === 1 ? gameState.cols - 1 : gameState.cols;
        
        for (let col = 0; col < colCount; col++) {
            const px = (col + offset) * gameState.cellSize + gameState.offsetX + gameState.cellSize / 2;
            const py = row * gameState.cellSize * 0.866 + gameState.offsetY + gameState.cellSize / 2;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–≤–æ–±–æ–¥–Ω–∞ –ª–∏ –ø–æ–∑–∏—Ü–∏—è
            const existing = gameState.grid[row]?.[col];
            if (existing && existing.visible) continue;
            
            // –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä—è–¥–æ–º —Å —á–µ–º-—Ç–æ –∏–ª–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —Ä—è–¥—É
            const hasNeighbor = row === 0 || getNeighbors(row, col).some(n => n && n.visible);
            if (!hasNeighbor) continue;
            
            const dist = Math.hypot(x - px, y - py);
            if (dist < bestDist) {
                bestDist = dist;
                best = { row, col, x: px, y: py };
            }
        }
    }
    
    return best;
}

function getNeighbors(row, col) {
    const neighbors = [];
    const isOdd = row % 2 === 1;
    
    // –°–º–µ—â–µ–Ω–∏—è –¥–ª—è —Å–æ—Å–µ–¥–µ–π –≤ –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–µ
    const offsets = isOdd ? [
        [-1, 0], [-1, 1],
        [0, -1], [0, 1],
        [1, 0], [1, 1]
    ] : [
        [-1, -1], [-1, 0],
        [0, -1], [0, 1],
        [1, -1], [1, 0]
    ];
    
    for (const [dr, dc] of offsets) {
        const r = row + dr;
        const c = col + dc;
        if (gameState.grid[r]?.[c]) {
            neighbors.push(gameState.grid[r][c]);
        }
    }
    
    return neighbors;
}

// ============================================
// –°–û–í–ü–ê–î–ï–ù–ò–Ø –ò –û–ë–í–ê–õ–´
// ============================================

function checkMatches(startYarn) {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∫–ª—É–±–∫–∏ —Ç–æ–≥–æ –∂–µ —Ü–≤–µ—Ç–∞
    const matchColor = startYarn.type === 'rainbow' ? null : startYarn.color;
    const matched = new Set();
    const toCheck = [startYarn];
    
    while (toCheck.length > 0) {
        const yarn = toCheck.pop();
        if (matched.has(yarn)) continue;
        
        // –†–∞–¥—É–∂–Ω—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª—é–±—ã–º
        if (matchColor === null || yarn.color === matchColor || yarn.type === 'rainbow') {
            matched.add(yarn);
            
            const neighbors = getNeighbors(yarn.row, yarn.col);
            neighbors.forEach(n => {
                if (n && n.visible && !matched.has(n)) {
                    toCheck.push(n);
                }
            });
        }
    }
    
    if (matched.size >= 3) {
        // –£–¥–∞–ª—è–µ–º —Å–æ–≤–ø–∞–≤—à–∏–µ
        removeMatched(Array.from(matched));
    } else {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–∏–≥—Ä—ã—à–∞
        checkLose();
    }
}

function removeMatched(yarns) {
    gameState.isAnimating = true;
    
    // –ó–≤—É–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    playMatchSound();
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã
    yarns.forEach(yarn => {
        // –ë–æ–º–±–∞
        if (yarn.type === 'bomb') {
            const neighbors = getNeighbors(yarn.row, yarn.col);
            neighbors.forEach(n => {
                if (n && n.visible && !yarns.includes(n)) {
                    yarns.push(n);
                }
            });
            gameState.progress.bomb = (gameState.progress.bomb || 0) + 1;
        }
        
        // –ó–≤–µ—Ä—É—à–∫–∞
        if (yarn.type === 'animal') {
            gameState.progress.animal = (gameState.progress.animal || 0) + 1;
            triggerSheepReaction('clap');
            playAnimalSound();
        }
        
        // –õ—ë–¥
        if (yarn.type === 'ice') {
            yarn.iceHits++;
            if (yarn.iceHits < 2) {
                // –ù–µ —É–¥–∞–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –ø–æ–≤—Ä–µ–∂–¥–∞–µ–º
                yarns.splice(yarns.indexOf(yarn), 1);
            } else {
                gameState.progress.ice = (gameState.progress.ice || 0) + 1;
            }
        }
        
        // –õ–∏–ø—É—á–∫–∞
        if (yarn.type === 'sticky') {
            gameState.progress.sticky = (gameState.progress.sticky || 0) + 1;
        }
    });
    
    // –≠—Ñ—Ñ–µ–∫—Ç "—Ä–∞—Å–ø—É—à–µ–Ω–∏—è"
    yarns.forEach(yarn => {
        createPuffEffect(yarn.x, yarn.y, yarn.color);
        yarn.visible = false;
    });
    
    // –ü–æ–¥—Å—á—ë—Ç
    gameState.progress.match = (gameState.progress.match || 0) + yarns.length;
    
    // –†–µ–∞–∫—Ü–∏—è –æ–≤–µ—á–∫–∏
    if (yarns.length >= 5) {
        triggerSheepReaction('happy');
    } else if (yarns.length >= 8) {
        triggerSheepReaction('spin');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–≤–∞–ª—ã
    setTimeout(() => {
        checkFloating();
    }, 300);
}

function checkFloating() {
    // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –≤–µ—Ä—Ö–æ–º
    const connected = new Set();
    
    // –ù–∞—á–∏–Ω–∞–µ–º —Å –≤–µ—Ä—Ö–Ω–µ–≥–æ —Ä—è–¥–∞
    if (gameState.grid[0]) {
        gameState.grid[0].forEach(yarn => {
            if (yarn && yarn.visible) {
                markConnected(yarn, connected);
            }
        });
    }
    
    // –í—Å–µ –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ ‚Äî –ø–∞–¥–∞—é—Ç
    const falling = [];
    for (let row = 0; row < gameState.grid.length; row++) {
        for (let col = 0; col < (gameState.grid[row]?.length || 0); col++) {
            const yarn = gameState.grid[row][col];
            if (yarn && yarn.visible && !connected.has(yarn)) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–ø—É—á–∫–∏ ‚Äî –æ–Ω–∏ —É–¥–µ—Ä–∂–∏–≤–∞—é—Ç
                if (yarn.type === 'sticky') continue;
                const neighbors = getNeighbors(yarn.row, yarn.col);
                if (neighbors.some(n => n && n.visible && n.type === 'sticky')) continue;
                
                falling.push(yarn);
            }
        }
    }
    
    if (falling.length > 0) {
        // –ó–≤—É–∫ –æ–±–≤–∞–ª–∞
        playDropSound(falling.length);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è
        animateFalling(falling);
        
        // –°—á—ë—Ç—á–∏–∫ –æ–±–≤–∞–ª–æ–≤
        gameState.progress.drop = (gameState.progress.drop || 0) + falling.length;
        
        // –†–µ–∞–∫—Ü–∏—è –æ–≤–µ—á–∫–∏ –Ω–∞ –±–æ–ª—å—à–æ–π –æ–±–≤–∞–ª
        if (falling.length >= 5) {
            triggerSheepReaction('happy');
        }
    } else {
        gameState.isAnimating = false;
        checkWin();
        updateUI();
    }
}

function markConnected(yarn, connected) {
    if (connected.has(yarn)) return;
    connected.add(yarn);
    
    const neighbors = getNeighbors(yarn.row, yarn.col);
    neighbors.forEach(n => {
        if (n && n.visible && !connected.has(n)) {
            markConnected(n, connected);
        }
    });
}

function animateFalling(yarns) {
    // –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ (–æ–±–≤–∞–ª–µ)
    // –ü—Ä–∏ –æ–±–≤–∞–ª–µ –ª—ë–¥/–∑–≤–µ—Ä—É—à–∫–∏/–ª–∏–ø—É—á–∫–∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É ‚Äî –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–ø–∞–¥–∞—Ç—å –¥–≤–∞–∂–¥—ã!
    yarns.forEach(yarn => {
        if (yarn.type === 'ice') {
            gameState.progress.ice = (gameState.progress.ice || 0) + 1;
        }
        if (yarn.type === 'animal') {
            gameState.progress.animal = (gameState.progress.animal || 0) + 1;
            triggerSheepReaction('clap');
            playAnimalSound();
        }
        if (yarn.type === 'sticky') {
            gameState.progress.sticky = (gameState.progress.sticky || 0) + 1;
        }
        if (yarn.type === 'bomb') {
            gameState.progress.bomb = (gameState.progress.bomb || 0) + 1;
        }
    });
    
    yarns.forEach(yarn => {
        yarn.falling = true;
        yarn.fallY = yarn.y;
        yarn.fallVel = 0;
    });
    
    function animate() {
        let stillFalling = false;
        
        yarns.forEach(yarn => {
            if (yarn.falling) {
                yarn.fallVel += 0.8; // –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è
                yarn.fallY += yarn.fallVel;
                
                if (yarn.fallY < canvas.height + 100) {
                    stillFalling = true;
                } else {
                    yarn.visible = false;
                    yarn.falling = false;
                }
            }
        });
        
        if (stillFalling) {
            requestAnimationFrame(animate);
        } else {
            // –í–æ–∑–º–æ–∂–Ω—ã —Ü–µ–ø–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—â—ë —Ä–∞–∑
            setTimeout(() => {
                gameState.isAnimating = false;
                checkWin();
                updateUI();
            }, 100);
        }
    }
    
    animate();
}

// ============================================
// –≠–§–§–ï–ö–¢–´
// ============================================

function createPuffEffect(x, y, color) {
    const colorData = COLORS[color] || COLORS.cream;
    
    // –í–æ–ª–æ–∫–Ω–∞
    for (let i = 0; i < 12; i++) {
        const fiber = document.createElement('div');
        fiber.className = 'fiber';
        fiber.style.left = x + 'px';
        fiber.style.top = y + 'px';
        fiber.style.backgroundColor = colorData.fill;
        
        const angle = (Math.PI * 2 / 12) * i;
        const dist = 30 + Math.random() * 40;
        fiber.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
        fiber.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
        fiber.style.setProperty('--rot', (Math.random() * 360) + 'deg');
        
        document.getElementById('game-container').appendChild(fiber);
        setTimeout(() => fiber.remove(), 1200);
    }
}

function triggerSheepReaction(type) {
    const sheep = document.getElementById('sheep');
    sheep.classList.remove('happy', 'spin', 'clap');
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        sheep.classList.add(type);
        setTimeout(() => sheep.classList.remove(type), 800);
    }, 50);
}

// ============================================
// –ü–†–û–í–ï–†–ö–ê –ü–û–ë–ï–î–´ / –ü–û–†–ê–ñ–ï–ù–ò–Ø
// ============================================

function checkWinOrLose() {
    const allGoalsMet = gameState.goals.every(goal => {
        return (gameState.progress[goal.type] || 0) >= goal.count;
    });
    
    if (allGoalsMet) {
        // –ü–æ–±–µ–¥–∞!
        const movesLeft = gameState.maxMoves - gameState.moves;
        let stars = 1;
        if (movesLeft >= gameState.maxMoves * 0.3) stars = 2;
        if (movesLeft >= gameState.maxMoves * 0.5) stars = 3;
        
        gameState.levelStars[gameState.currentLevel] = Math.max(
            gameState.levelStars[gameState.currentLevel] || 0,
            stars
        );
        
        if (gameState.currentLevel + 1 >= gameState.unlockedLevels) {
            gameState.unlockedLevels = Math.min(gameState.currentLevel + 2, LEVELS.length);
        }
        
        saveProgress();
        showWinModal(stars);
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∏–≥—Ä—ã—à ‚Äî —Ö–æ–¥—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
    if (gameState.moves >= gameState.maxMoves) {
        showLoseModal();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–æ –ª–∏ –ø–æ–ª–µ
    const lastRow = gameState.grid[gameState.grid.length - 1];
    const overflow = lastRow?.some(y => y && y.visible && y.y > canvas.height - 50);
    
    if (overflow) {
        showLoseModal();
    }
}

// –ê–ª–∏–∞—Å—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
function checkWin() {
    checkWinOrLose();
}

function checkLose() {
    checkWinOrLose();
}

function showWinModal(stars) {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑
    if (gameState.levelEnded) return;
    gameState.levelEnded = true;
    
    playWinSound();
    
    const modal = document.getElementById('win-modal');
    document.getElementById('win-stars').textContent = '‚≠ê'.repeat(stars) + '‚òÜ'.repeat(3 - stars);
    modal.classList.add('active');
}

function showLoseModal() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑
    if (gameState.levelEnded) return;
    gameState.levelEnded = true;
    
    document.getElementById('lose-modal').classList.add('active');
}

// ============================================
// UI
// ============================================

function updateUI() {
    // –£—Ä–æ–≤–µ–Ω—å
    document.getElementById('level-num').textContent = `–£—Ä–æ–≤–µ–Ω—å ${gameState.currentLevel + 1}`;
    
    // –¶–µ–ª–∏
    const goalsEl = document.getElementById('goals');
    goalsEl.innerHTML = '';
    
    gameState.goals.forEach(goal => {
        const current = gameState.progress[goal.type] || 0;
        const completed = current >= goal.count;
        
        const div = document.createElement('div');
        div.className = 'goal-item' + (completed ? ' completed' : '');
        div.innerHTML = `
            <span class="goal-icon">${goal.icon}</span>
            <span class="goal-count">${current}/${goal.count}</span>
        `;
        goalsEl.appendChild(div);
    });
    
    // –•–æ–¥—ã
    const movesGoal = document.createElement('div');
    movesGoal.className = 'goal-item';
    movesGoal.innerHTML = `
        <span class="goal-icon">üéØ</span>
        <span class="goal-count">${gameState.maxMoves - gameState.moves}</span>
    `;
    goalsEl.appendChild(movesGoal);
    
    // –¢–µ–∫—É—â–∏–π –∫–ª—É–±–æ–∫
    updateYarnPreview();
    
    // –û–≤–µ—á–∫–∞ –±–µ—Å–ø–æ–∫–æ–∏—Ç—Å—è –ø—Ä–∏ –º–∞–ª–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ö–æ–¥–æ–≤
    if (gameState.maxMoves - gameState.moves <= 3) {
        document.getElementById('sheep').style.filter = 'hue-rotate(-20deg)';
    } else {
        document.getElementById('sheep').style.filter = '';
    }
}

function updateYarnPreview() {
    const currentEl = document.getElementById('current-yarn');
    const nextEl = document.getElementById('next-yarn');
    
    if (gameState.currentYarn) {
        const colorData = COLORS[gameState.currentYarn.color];
        if (gameState.currentYarn.type === 'rainbow') {
            currentEl.style.background = 'linear-gradient(135deg, #FFB5B5, #FFCBA4, #FFF5E1, #98D8C8, #A8D8EA, #C9B1FF)';
            currentEl.innerHTML = '<span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;">üåà</span>';
        } else {
            currentEl.style.background = `linear-gradient(135deg, ${lightenColor(colorData.fill, 20)} 0%, ${colorData.fill} 50%, ${colorData.stroke} 100%)`;
            currentEl.innerHTML = '';
        }
    }
    
    if (gameState.nextYarn) {
        const colorData = COLORS[gameState.nextYarn.color];
        if (gameState.nextYarn.type === 'rainbow') {
            nextEl.style.background = 'linear-gradient(135deg, #FFB5B5, #FFCBA4, #FFF5E1, #98D8C8, #A8D8EA, #C9B1FF)';
            nextEl.innerHTML = '<span style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px;">üåà</span>';
        } else {
            nextEl.style.background = `linear-gradient(135deg, ${lightenColor(colorData.fill, 20)} 0%, ${colorData.fill} 50%, ${colorData.stroke} 100%)`;
            nextEl.innerHTML = '';
        }
    }
}

// ============================================
// –°–û–ë–´–¢–ò–Ø
// ============================================

function setupEvents() {
    // –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
    document.getElementById('start-btn').onclick = () => {
        initAudio();
        showScreen('levels');
    };
    
    // –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å!" –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —É—Ä–æ–≤–Ω—è
    document.getElementById('start-level-btn').onclick = () => {
        document.getElementById('level-intro-modal').classList.remove('active');
        if (gameState.pendingLevel !== undefined) {
            startLevel(gameState.pendingLevel);
            delete gameState.pendingLevel;
        }
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ‚Äî –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    document.getElementById('intro-back-btn').onclick = () => {
        document.getElementById('level-intro-modal').classList.remove('active');
        delete gameState.pendingLevel;
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ‚Äî –∫—Ä–µ—Å—Ç–∏–∫
    document.getElementById('intro-close-btn').onclick = () => {
        document.getElementById('level-intro-modal').classList.remove('active');
        delete gameState.pendingLevel;
    };
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è —É—Ä–æ–≤–Ω—è ‚Äî –∫–ª–∏–∫ –Ω–∞ —Ñ–æ–Ω (–≤–Ω–µ –º–æ–¥–∞–ª–∫–∏)
    document.getElementById('level-intro-modal').onclick = (e) => {
        if (e.target.id === 'level-intro-modal') {
            document.getElementById('level-intro-modal').classList.remove('active');
            delete gameState.pendingLevel;
        }
    };
    
    // –ü–∞—É–∑–∞
    document.getElementById('pause-btn').onclick = () => {
        gameState.isPaused = true;
        document.getElementById('pause-modal').classList.add('active');
    };
    
    document.getElementById('resume-btn').onclick = () => {
        gameState.isPaused = false;
        document.getElementById('pause-modal').classList.remove('active');
    };
    
    document.getElementById('menu-btn').onclick = () => {
        gameState.isPaused = false;
        document.getElementById('pause-modal').classList.remove('active');
        showScreen('levels');
    };
    
    // –ü–æ–±–µ–¥–∞
    document.getElementById('next-level-btn').onclick = () => {
        document.getElementById('win-modal').classList.remove('active');
        if (gameState.currentLevel + 1 < LEVELS.length) {
            showLevelIntro(gameState.currentLevel + 1);
        } else {
            showScreen('levels');
        }
    };
    
    document.getElementById('win-menu-btn').onclick = () => {
        document.getElementById('win-modal').classList.remove('active');
        showScreen('levels');
    };
    
    // –ü—Ä–æ–∏–≥—Ä—ã—à
    document.getElementById('retry-btn').onclick = () => {
        document.getElementById('lose-modal').classList.remove('active');
        startLevel(gameState.currentLevel); // –ø—Ä–∏ retry —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞–µ–º, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ intro
    };
    
    document.getElementById('lose-menu-btn').onclick = () => {
        document.getElementById('lose-modal').classList.remove('active');
        showScreen('levels');
    };
    
    // –ü—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ –º—ã—à—å—é
    canvas.addEventListener('mousemove', handleAim);
    canvas.addEventListener('touchmove', handleAimTouch, { passive: false });
    
    canvas.addEventListener('click', handleShoot);
    canvas.addEventListener('touchend', handleShootTouch);
}

function handleAim(e) {
    if (gameState.isPaused || gameState.isAnimating) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –Ω–∏–∑–∞ –∫ –∫—É—Ä—Å–æ—Ä—É
    const centerX = canvas.width / 2;
    const centerY = canvas.height + 30;
    
    let angle = Math.atan2(centerY - y, x - centerX);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —É–≥–æ–ª
    angle = Math.max(0.2, Math.min(Math.PI - 0.2, angle));
    
    gameState.aimAngle = angle;
    gameState.isAiming = true;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–Ω–∏—é –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è
    updateAimLine(angle);
}

function handleAimTouch(e) {
    e.preventDefault();
    if (e.touches.length > 0) {
        const touch = e.touches[0];
        handleAim({ clientX: touch.clientX, clientY: touch.clientY });
    }
}

function handleShoot(e) {
    if (gameState.isPaused || gameState.isAnimating) return;
    if (gameState.moves >= gameState.maxMoves) return;
    
    playShootSound();
    shoot(gameState.aimAngle);
    gameState.isAiming = false;
    updateAimLine(0);
}

function handleShootTouch(e) {
    handleShoot(e);
}

function updateAimLine(angle) {
    const line = document.getElementById('aim-line');
    
    if (angle === 0) {
        line.style.height = '0';
        return;
    }
    
    const length = 200;
    const rotation = -(angle * 180 / Math.PI - 90);
    
    line.style.height = length + 'px';
    line.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
}

// ============================================
// –†–ï–ù–î–ï–†
// ============================================

function gameLoop() {
    if (gameState.screen === 'playing') {
        render();
    }
    requestAnimationFrame(gameLoop);
}

function render() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –†–∏—Å—É–µ–º –∫–ª—É–±–∫–∏
    for (let row = 0; row < gameState.grid.length; row++) {
        for (let col = 0; col < (gameState.grid[row]?.length || 0); col++) {
            const yarn = gameState.grid[row][col];
            if (!yarn || !yarn.visible) continue;
            
            const x = yarn.falling ? yarn.x : yarn.x;
            const y = yarn.falling ? yarn.fallY : yarn.y;
            
            drawYarn(x, y, yarn);
        }
    }
    
    // –õ–µ—Ç—è—â–∏–π –∫–ª—É–±–æ–∫
    if (gameState.currentYarn?.animX !== undefined) {
        drawShootingYarn(gameState.currentYarn);
    }
}

function drawYarn(x, y, yarn) {
    const size = gameState.cellSize * 0.45;
    const colorData = COLORS[yarn.color] || COLORS.cream;
    
    ctx.save();
    
    // –¢–µ–Ω—å
    ctx.beginPath();
    ctx.arc(x + 2, y + 2, size, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
    ctx.fill();
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä—É–≥
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä—ë–º–∞
    const gradient = ctx.createRadialGradient(x - size * 0.3, y - size * 0.3, 0, x, y, size);
    gradient.addColorStop(0, lightenColor(colorData.fill, 30));
    gradient.addColorStop(0.7, colorData.fill);
    gradient.addColorStop(1, colorData.stroke);
    
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // –¢–µ–∫—Å—Ç—É—Ä–∞ –Ω–∏—Ç–æ–∫ (–ø—Ä–æ—Å—Ç—ã–µ –ª–∏–Ω–∏–∏)
    ctx.strokeStyle = colorData.stroke;
    ctx.lineWidth = 1;
    ctx.globalAlpha = 0.3;
    
    for (let i = 0; i < 5; i++) {
        ctx.beginPath();
        const startAngle = (Math.PI * 2 / 5) * i + yarn.row * 0.5;
        ctx.arc(x, y, size * 0.6, startAngle, startAngle + Math.PI * 0.8);
        ctx.stroke();
    }
    
    ctx.globalAlpha = 1;
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã
    if (yarn.type !== 'normal') {
        ctx.font = `${size}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        let emoji = SPECIAL_TYPES[yarn.type]?.emoji || '';
        
        // –õ—ë–¥ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ
        if (yarn.type === 'ice' && yarn.iceHits > 0) {
            ctx.globalAlpha = 0.6;
        }
        
        // –¢—É–º–∞–Ω ‚Äî —Å–∫—Ä—ã–≤–∞–µ—Ç
        if (yarn.type === 'fog') {
            ctx.globalAlpha = 0.7;
        }
        
        if (emoji) {
            ctx.fillText(emoji, x, y);
        }
        
        ctx.globalAlpha = 1;
    }
    
    ctx.restore();
}

function drawShootingYarn(yarn) {
    const size = gameState.cellSize * 0.45;
    const colorData = COLORS[yarn.color] || COLORS.cream;
    
    ctx.save();
    
    ctx.beginPath();
    ctx.arc(yarn.animX, yarn.animY, size, 0, Math.PI * 2);
    
    const gradient = ctx.createRadialGradient(
        yarn.animX - size * 0.3, yarn.animY - size * 0.3, 0,
        yarn.animX, yarn.animY, size
    );
    gradient.addColorStop(0, lightenColor(colorData.fill, 30));
    gradient.addColorStop(1, colorData.fill);
    
    ctx.fillStyle = gradient;
    ctx.fill();
    
    if (yarn.type === 'rainbow') {
        ctx.font = `${size}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('üåà', yarn.animX, yarn.animY);
    }
    
    ctx.restore();
}

function lightenColor(hex, percent) {
    const num = parseInt(hex.replace('#', ''), 16);
    const amt = Math.round(2.55 * percent);
    const R = Math.min(255, (num >> 16) + amt);
    const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
    const B = Math.min(255, (num & 0x0000FF) + amt);
    return `rgb(${R}, ${G}, ${B})`;
}

// ============================================
// –°–¢–ê–†–¢
// ============================================

window.onload = init;
</script>

</body>
</html>
